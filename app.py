from flask import Flask, render_template, request, redirect, url_for, flash, session, jsonify
import sqlite3
import os
from flask_bcrypt import Bcrypt
import ollama 


app = Flask(__name__)
app.secret_key = 'YourSecretKey'  # Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ù…ÙØªØ§Ø­ Ø£Ù‚ÙˆÙ‰ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬
bcrypt = Bcrypt(app)

# Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def get_db_connection():
    conn = sqlite3.connect('database.db')
    conn.row_factory = sqlite3.Row
    return conn

# Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
def init_db():
    conn = get_db_connection()
    conn.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT NOT NULL UNIQUE CHECK(email LIKE '%@gmail.com'),
            password TEXT NOT NULL
        )
    ''')
    conn.commit()
    conn.close()

# ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
init_db()

# Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
@app.route('/')
def index():
    return render_template('index.html')

# ØµÙØ­Ø© about
@app.route('/about')
def about():
    return render_template('about.html')

# ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
@app.route('/projects')
def projects():
    return render_template('projects.html')

# ØµÙØ­Ø© Ø§Ù„ØªÙˆØµÙŠØ§Øª
@app.route('/recommendation', methods=['GET', 'POST'])
def recommendation():
    if request.method == 'GET':
        # Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¯ÙˆÙ† ØªÙˆÙ„ÙŠØ¯ Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰
        return render_template('recommendation.html', generated_content=None)
    
    # Ø¹Ù†Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ POST Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if 'user_id' not in session:
        return jsonify({"error": "ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!"}), 401

    generated_content = None
    if request.method == 'POST':
        donation_type = request.form.get("donation_type")
        amount = request.form.get("amount")
        duration = request.form.get("duration")

        prompt = f"""
        Ù„Ø¯ÙŠÙƒ Ø­Ù…Ù„Ø© ØªØ¨Ø±Ø¹ Ø¬Ø¯ÙŠØ¯Ø©:
        - Ù†ÙˆØ¹ Ø§Ù„ØªØ¨Ø±Ø¹: {donation_type}
        - Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: {amount} Ø¬Ù†ÙŠÙ‡
        - Ø§Ù„Ù…Ø¯Ø©: {duration} ÙŠÙˆÙ…Ù‹Ø§

        Ù…Ø§ Ù‡ÙŠ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªÙ‚Ø¯ÙŠÙ…Ù‡Ø§ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ù†Ø¬Ø§Ø­Ù‡Ø§ØŸ
        """

        response = ollama.chat(model="mistral", messages=[{"role": "user", "content": prompt}])
        generated_content = response['message']['content']
    
    return render_template('recommendation.html', generated_content=generated_content)


# Ù…Ø³Ø§Ø± Ø¹Ø±Ø¶ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
@app.route('/login', methods=['GET'])
def show_login():
    return render_template('register.html')


# Ù…Ø³Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
@app.route('/login', methods=['POST'])
def login():
    email = request.form.get('email')
    password = request.form.get('password')

    conn = get_db_connection()
    user = conn.execute('SELECT * FROM users WHERE email = ?', (email,)).fetchone()
    conn.close()

    if user:
        if bcrypt.check_password_hash(user['password'], password):
            session['user_id'] = user['id']
            session['user_name'] = user['name']
            flash('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success')
            return redirect(url_for('index'))
        else:
            flash('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error')  # Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§
    else:
        flash('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯.', 'error')

    return render_template('register.html', email=email)

# Ù…Ø³Ø§Ø± Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
@app.route('/register', methods=['GET'])
def show_register():
    return render_template('register.html')

# API Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
@app.route('/check_email', methods=['POST'])
def check_email():
    email = request.json.get('email')

    conn = get_db_connection()
    user = conn.execute('SELECT * FROM users WHERE email = ?', (email,)).fetchone()
    conn.close()

    return jsonify({"exists": bool(user)})

# Ù…Ø³Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„ØªØ³Ø¬ÙŠÙ„)
@app.route('/register', methods=['POST'])
def register():
    name = request.form.get('name')
    email = request.form.get('email')
    password = request.form.get('password')
    confirm_password = request.form.get('confirm_password')

    if not email.endswith('@gmail.com'):
        flash('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØªØ§Ø¨Ø¹Ù‹Ø§ Ù„Ù€ Gmail (Ù…Ø«Ø§Ù„: user@gmail.com)!', 'error')
        return redirect(url_for('show_register'))

    conn = get_db_connection()
    existing_user = conn.execute('SELECT * FROM users WHERE email = ?', (email,)).fetchone()

    if existing_user:
        flash('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¢Ø®Ø±.', 'error')
        return redirect(url_for('show_register'))

    if password != confirm_password:
        flash('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†!', 'error')
        return redirect(url_for('show_register'))

    hashed_password = bcrypt.generate_password_hash(password).decode('utf-8')

    try:
        conn.execute('INSERT INTO users (name, email, password) VALUES (?, ?, ?)',
                     (name, email, hashed_password))
        conn.commit()
        
        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
        user = conn.execute('SELECT * FROM users WHERE email = ?', (email,)).fetchone()
        session['user_id'] = user['id']
        session['user_name'] = user['name']
        
        flash('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ˜Š', 'success')
        return redirect(url_for('index'))
    finally:
        conn.close()

# Ù…Ø³Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
@app.route('/logout')
def logout():
    session.clear()
    flash('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.', 'success')
    return redirect(url_for('index'))


# Ù…Ø³Ø§Ø± Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
@app.route('/forgot_password', methods=['GET', 'POST'])
def forgot_password():
    if request.method == 'POST':
        email = request.form.get('email')
        
        conn = get_db_connection()
        user = conn.execute('SELECT * FROM users WHERE email = ?', (email,)).fetchone()
        conn.close()

        if user:
            flash('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.', 'success')
            return redirect(url_for('show_login'))
        else:
            flash('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§!', 'error')
            return redirect(url_for('forgot_password'))
    else:
        flash('Ù…ÙŠØ²Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹!', 'error')
        return redirect(url_for('login'))

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5010)